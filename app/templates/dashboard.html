{% extends "base.html" %}

{% block title %}AWS JobLens: Keyword Analysis{% endblock %}

{% block body_class %}dashboard-pg{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Page Title -->
    <div class="mb-4 text-center">
        <h1>AWS JobLens Dashboard</h1>
        <p>Explore insights from AWS-related job descriptions to identify popular skills and technologies.</p>
    </div>
<!-- Filter Card -->
    <div class="row mb-5">
        <div class="col-md-10 offset-md-1">
            <div class="card p-4 shadow-sm filter-card">
                <div class="row align-items-center mb-3">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <label for="searchInput" class="form-label">Search Jobs Based on Skills</label>
                        <input type="text" id="searchInput" class="form-control" placeholder="e.g., docker, python">
                    </div>
                    <div class="col-md-3 mb-3 mb-md-0">
                        <label for="locationFilter" class="form-label">Filter by Location</label>
                        <select id="locationFilter" class="form-select">
                            <option value="All">All Locations</option>
                            <!-- JS injects options -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="experienceFilter" class="form-label">Filter by Experience Level</label>
                        <select id="experienceFilter" class="form-select">
                            <option value="All">All Experience Levels</option>
                            <!-- JS injects options -->
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphs Row -->
    <div class="row">
        <!-- Keyword Analysis Chart -->
        <div class="col-md-6 mb-4">
            <div class="graph-card">
                <h3 class="graph-title text-center">Keyword Frequency Analysis</h3>
                <p class="graph-description">Shows most frequently mentioned keywords from AWS job descriptions.</p>
                <div id="keywordChart" class="plotly-graph"></div>
            </div>
        </div>

        <!-- Job Title Distribution Graph -->
        <div class="col-md-6 mb-4">
            <div class="graph-card">
                <h3 class="graph-title text-center">Job Title Distribution</h3>
                <p class="graph-description">Shows the distribution of various job titles from the dataset.</p>
                <div id="jobTitleChart" class="plotly-graph"></div>
            </div>
        </div>

        <!-- Employment Type Distribution -->
        <div class="col-md-6 mb-4">
            <div class="graph-card">
                <h3 class="graph-title text-center">Employment Type Distribution</h3>
                <p class="graph-description">Shows the distribution of job types (Full-time, Part-time, Contract).</p>
                <div id="employmentTypeChart" class="plotly-graph"></div>
            </div>
        </div>

        <!-- Experience Level Analysis -->
        <div class="col-md-6 mb-4">
            <div class="graph-card">
                <h3 class="graph-title text-center">Experience Level Analysis</h3>
                <p class="graph-description">Shows the distribution of required experience levels for jobs.</p>
                <div id="experienceLevelChart" class="plotly-graph"></div>
            </div>
        </div>
        <!-- Location Analysis -->
        <div class="col-md-6 mb-4">
            <div class="graph-card">
                <h3 class="graph-title text-center">Location Analysis</h3>
                <p class="graph-description">Shows the distribution of job postings by location.</p>
                <div id="locationChart" class="plotly-graph"></div>
            </div>
        </div>

        <!-- Salary Range Analysis -->
        <div class="col-md-6 mb-4">
            <div class="graph-card">
                <h3 class="graph-title text-center">Salary Range Analysis</h3>
                <p class="graph-description">Shows the distribution of job salary ranges.</p>
                <div id="salaryChart" class="plotly-graph"></div>
            </div>
        </div>
    </div>
</div>

<!-- Plotly.js for Graphs -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('✅ Dashboard Page Loaded');
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.trim();
            loadAllGraphs(locationDropdown.value, experienceDropdown.value, query);
        });


        const layoutSettings = {
            margin: { t: 40, b: 50, l: 50, r: 50 },
            responsive: true,
            autosize: true,
            height: 350
        };

        // Step 1: Populate location dropdown
        fetch('/api/locations')
            .then(response => response.json())
            .then(locations => {
                const locationDropdown = document.getElementById('locationFilter');
                locations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc;
                    option.textContent = loc;
                    locationDropdown.appendChild(option);
                });

                // Initial graph load
                loadAllGraphs("All");
            });
        // Fetch and populate Experience Level filter
        fetch('/api/experience_levels')
            .then(response => response.json())
            .then(levels => {
                const experienceDropdown = document.getElementById('experienceFilter');
                levels.forEach(level => {
                    const option = document.createElement('option');
                    option.value = level;
                    option.textContent = level;
                    experienceDropdown.appendChild(option);
                });
            });


        // Step 2: Event listener for dropdown
        const locationDropdown = document.getElementById('locationFilter');
        const experienceDropdown = document.getElementById('experienceFilter');

        locationDropdown.addEventListener('change', () => {
            loadAllGraphs(locationDropdown.value, experienceDropdown.value);
        });

        experienceDropdown.addEventListener('change', () => {
            loadAllGraphs(locationDropdown.value, experienceDropdown.value);
        });


        // Step 3: Function to load all graphs based on location
        function loadAllGraphs(location, experience) {
            const params = new URLSearchParams();
            
            // ✅ Get the current search keyword from the input box
            const searchInput = document.getElementById('searchInput').value.trim();
                if (searchInput) {
                    const keywords = searchInput.split(',').map(k => k.trim()).filter(Boolean);
                    params.append("search", keywords.join(','));
                }


            if (location && location !== "All") params.append("location", location);
            if (experience && experience !== "All") params.append("experience", experience);

            const query = params.toString() ? `?${params.toString()}` : "";


            // Keywords
            fetch(`/api/keywords${query}`)
                .then(res => res.json())
                .then(data => {
                    Plotly.newPlot('keywordChart', [{
                        x: data.labels, y: data.values, type: 'bar', marker: { color: 'teal' }
                    }], { ...layoutSettings, xaxis: { title: 'Keywords', automargin: true }, yaxis: { title: 'Frequency', automargin: true } });
                });

            // Job Titles
            fetch(`/api/job_titles${query}`)
                .then(res => res.json())
                .then(data => {
                    Plotly.newPlot('jobTitleChart', [{
                        x: data.values,
                        y: data.labels,
                        type: 'bar',
                        orientation: 'h',
                        marker: { color: 'skyblue' }
                    }], {
                        ...layoutSettings,
                        yaxis: { title: 'Job Titles', automargin: true },
                        xaxis: { title: 'Count', automargin: true }
                    });
                });

            // Employment Type
            fetch(`/api/employment_type${query}`)
                .then(res => res.json())
                .then(data => {
                    Plotly.newPlot('employmentTypeChart', [{
                        labels: data.labels,
                        values: data.values,
                        type: 'pie',
                        hole: 0.4,
                        marker: { colors: ['#ff7f0e', '#1f77b4', '#2ca02c', '#d62728'] }
                    }], {
                        ...layoutSettings,
                        showlegend: true
                    });

                });

            // Experience Level
            fetch(`/api/experience_level${query}`)
                .then(res => res.json())
                .then(data => {
                    Plotly.newPlot('experienceLevelChart', [{
                        labels: data.labels, values: data.values, type: 'pie'
                    }], { ...layoutSettings });
                });

            // Location Chart
            fetch(`/api/location_analysis${query}`)
                .then(res => res.json())
                .then(data => {
                    Plotly.newPlot('locationChart', [{
                        x: data.values,
                        y: data.labels,
                        type: 'bar',
                        orientation: 'h',
                        marker: { color: 'orange' }
                    }], {
                        ...layoutSettings,
                        yaxis: { title: 'Locations', automargin: true },
                        xaxis: { title: 'Count', automargin: true }
                    });

                });

            // Salary Chart
            fetch(`/api/salary_analysis${query}`)
                .then(res => res.json())
                .then(data => {
                    Plotly.newPlot('salaryChart', [{
                        x: data.ranges,
                        y: data.counts,
                        type: 'scatter',
                        mode: 'lines+markers',
                        marker: { color: 'green' }
                    }], {
                        ...layoutSettings,
                        xaxis: { title: 'Salary Ranges', automargin: true },
                        yaxis: { title: 'Count', automargin: true }
                    });
                });
        }
    });
</script>


{% endblock %}
